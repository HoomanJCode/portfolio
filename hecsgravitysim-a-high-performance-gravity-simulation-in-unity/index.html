<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>HEcsGravitySim: A High-Performance Gravity Simulation in Unity - Hooman&#x27;s Portfolio</title><meta name="description" content="HEcsGravitySim is a multi-threaded gravity simulation using Unity's ECS and Job System&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><meta name="theme-color" content="#17181E" media="(prefers-color-scheme: dark)"><meta name="theme-color" content="#FFCE00" media="(prefers-color-scheme: light)"><meta name="msapplication-navbutton-color" content="#FFCE00"><meta name="apple-mobile-web-app-status-bar-style" content="#FFCE00"><link rel="canonical" href="https://hooman.jalalpoor.com/hecsgravitysim-a-high-performance-gravity-simulation-in-unity/"><link rel="alternate" type="application/atom+xml" href="https://hooman.jalalpoor.com/feed.xml" title="Hooman&#x27;s Portfolio - RSS"><link rel="alternate" type="application/json" href="https://hooman.jalalpoor.com/feed.json" title="Hooman&#x27;s Portfolio - JSON"><meta property="og:title" content="HEcsGravitySim: A High-Performance Gravity Simulation in Unity"><meta property="og:image" content="https://hooman.jalalpoor.com/media/posts/6/Capture-1.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="675"><meta property="og:site_name" content="Hooman's Portfolio"><meta property="og:description" content="HEcsGravitySim is a multi-threaded gravity simulation using Unity's ECS and Job System&hellip;"><meta property="og:url" content="https://hooman.jalalpoor.com/hecsgravitysim-a-high-performance-gravity-simulation-in-unity/"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://hooman.jalalpoor.com/media/website/minimal-art-style-website-favicon-for-a-game-developer-Copy.png" type="image/png"><link rel="stylesheet" href="https://hooman.jalalpoor.com/assets/css/style.css?v=703cd6501087ec69fd6a14b3f9297d41"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://hooman.jalalpoor.com/hecsgravitysim-a-high-performance-gravity-simulation-in-unity/"},"headline":"HEcsGravitySim: A High-Performance Gravity Simulation in Unity","datePublished":"2025-05-02T21:36+03:30","dateModified":"2025-05-02T21:37+03:30","image":{"@type":"ImageObject","url":"https://hooman.jalalpoor.com/media/posts/6/Capture-1.png","height":675,"width":1200},"description":"HEcsGravitySim is a multi-threaded gravity simulation using Unity's ECS and Job System&hellip;","author":{"@type":"Person","name":"Hooman Jalalpoor","url":"https://hooman.jalalpoor.com/authors/hooman-jalalpoor/"},"publisher":{"@type":"Organization","name":"Hooman Jalalpoor"}}</script><noscript><style>img[loading] {
                    opacity: 1;
                }</style></noscript><style>.extlink::before {
				background-color: currentColor;
				content: "";
				display: inline-block;
				height: 16px;
				margin-right: 5px;
				position: relative;
				top: 0px;
				width: 16px;
			}
		
					.extlink.extlink-icon-11::before {
						mask-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 24 24' fill='none' stroke='%23000000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' xmlns='http://www.w3.org/2000/svg'><path d='M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71'/><path d='M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71'/></svg>");
						mask-repeat: no-repeat;
						mask-size: contain;
					}</style></head><body class="post-template"><div class="container"><header class="header" id="js-header"><a href="https://hooman.jalalpoor.com/" class="logo">Hooman&#x27;s Portfolio</a><nav class="navbar js-navbar"><button class="navbar__toggle js-toggle" aria-label="Menu"><span class="navbar__toggle-box"><span class="navbar__toggle-inner">Menu</span></span></button><ul class="navbar__menu"><li class="has-submenu"><span class="is-separator" aria-haspopup="true">Links</span><ul class="navbar__submenu level-2" aria-hidden="true"><li><a href="https://hoomanj.itch.io/" target="_blank">Itch</a></li><li><a href="https://github.com/HoomanJCode" target="_blank">Github</a></li><li><a href="https://www.linkedin.com/in/hooman-jalalpoor/" target="_self">Linkedin</a></li><li><a href="https://www.fxhash.xyz/u/Parallax%20Rendering" target="_blank">Fxhash (Artworks)</a></li></ul></li><li><a href="https://hooman.jalalpoor.com/contact-me/" target="_self">Contact Me</a></li></ul></nav></header><main class="post"><article class="content wrapper"><header class="hero"><p class="content__meta">By <a href="https://hooman.jalalpoor.com/authors/hooman-jalalpoor/" rel="author" title="Hooman Jalalpoor">Hooman Jalalpoor</a> Published on <time datetime="2025-05-02T21:36">May 2, 2025</time></p><h1 class="content__title">HEcsGravitySim: A High-Performance Gravity Simulation in Unity</h1></header><figure class="content__featured-image post__image--normal"><img src="https://hooman.jalalpoor.com/media/posts/6/Capture-1.png" srcset="https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-xs.png 300w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-sm.png 480w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-md.png 768w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-lg.png 1024w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-xl.png 1360w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-2xl.png 1600w, https://hooman.jalalpoor.com/media/posts/6/responsive/Capture-1-sm2.png 375w" sizes="(max-width: 1600px) 100vw, 1600px" loading="eager" height="675" width="1200" alt=""><figcaption>HEcsGravitySim is a multi-threaded gravity simulation using Unity&#x27;s ECS and Job System for real-time performance. 🚀</figcaption></figure><div class="content__entry"><p>HEcsGravitySim is a multi-threaded gravity simulation using Unity's ECS and Job System for real-time performance. 🚀</p><h2 id="introduction">Introduction</h2><p>Gravity simulations are computationally expensive, especially when dealing with numerous objects. In this project, <strong>HEcsGravitySim</strong>, we tackle this challenge using <strong>Unity's ECS (Entity Component System)</strong> and <strong>Job System</strong> to leverage multi-threading for real-time calculations. Instead of processing thousands of gravitational interactions on a single thread, which would be highly inefficient, we distribute the computations across multiple threads for a significant performance boost.</p><h2 id="the-problem-gravity-calculation-bottleneck">The Problem: Gravity Calculation Bottleneck</h2><p>In a naive implementation of a gravity simulation, each planet applies a force to every other planet. This results in a <strong>nested loop</strong> with <strong>O(n²) complexity</strong>, where each frame requires computing forces for every pair of planets. With <strong>1000 planets</strong>, this means 1,000,000 force calculations per frame! Running this on a single thread would lead to severe performance issues.</p><h2 id="the-solution-multi-threading-and-data-oriented-programming">The Solution: Multi-Threading and Data-Oriented Programming</h2><p>To overcome this computational bottleneck, we use Unity's <strong>Data-Oriented Technology Stack (DOTS)</strong>, which includes:</p><ul><li><strong>Job System</strong> – Enables multithreaded computations efficiently.</li><li><strong>ECS (Entity Component System)</strong> – Provides a high-performance, data-oriented programming model.</li><li><strong>Hybrid Renderer Package</strong> – Ensures optimized rendering.</li><li><strong>Unity Physics (Havok Physics)</strong> – Handles physics interactions accurately.</li></ul><p>By structuring the simulation using <strong>ECS and Jobs</strong>, we efficiently distribute calculations across multiple CPU cores, leading to a significant boost in performance and real-time simulation capabilities.</p><h2 id="gravity-calculation-formula">Gravity Calculation Formula</h2><p>The gravitational force between two planets is calculated using Newton's Law of Universal Gravitation:</p><p>F=Gm1m2r2F = G \frac{m_1 m_2}{r^2}</p><p>Where:</p><ul><li>FF is the gravitational force,</li><li>GG is the gravitational constant,</li><li>m1,m2m_1, m_2 are the masses of the two planets,</li><li>rr is the distance between the two planets.</li></ul><h3 id="unity-implementation-example">Unity Implementation Example:</h3><pre class="language-glsl"><code>float3 direction = planet2.Position - planet1.Position;
float distanceSquared = math.lengthsq(direction) + 0.0001f; // Avoid division by zero
float forceMagnitude = (G * planet1.Mass * planet2.Mass) / distanceSquared;
float3 force = math.normalize(direction) * forceMagnitude;</code></pre><h2 id="project-breakdown">Project Breakdown</h2><h3 id="1-random-planet-generator">1. <strong>Random Planet Generator</strong></h3><ul><li>A class that generates <strong>randomly placed planets</strong> within the simulation space.</li><li>Assigns each planet a <strong>random velocity and mass</strong>.</li></ul><h3 id="2-planet-component-data">2. <strong>Planet Component Data</strong></h3><ul><li>Stores essential planet properties such as:<ul><li>Position</li><li>Velocity</li><li>Mass</li></ul></li></ul><h3 id="3-gravity-system">3. <strong>Gravity System</strong></h3><ul><li>Uses <strong>Entity Query</strong> to fetch all planets.</li><li>Executes a <strong>multithreaded job</strong> each frame to calculate gravitational forces efficiently.</li><li>Applies forces to the <strong>Velocity Component</strong>, allowing the physics engine to update positions automatically.</li></ul><h3 id="4-job-system-for-parallel-processing">4. <strong>Job System for Parallel Processing</strong></h3><ul><li>Each frame, the system:<ol><li>Loops over all planet entities using <strong>nested loops</strong>.</li><li>Distributes the calculations across multiple CPU cores using <strong>Jobs</strong>.</li><li>Applies the calculated forces to <strong>update velocity</strong> components.</li><li>The physics engine then computes the new positions.</li></ol></li></ul><h2 id="performance-gains">Performance Gains</h2><p>By implementing <strong>ECS and Job System</strong>, we achieve:</p><ul><li><strong>Massively improved performance</strong> due to parallel processing.</li><li><strong>Real-time gravity simulation</strong> with thousands of planets.</li><li><strong>Efficient memory management</strong>, reducing CPU bottlenecks.</li><li><strong>Smooth rendering</strong> using the Hybrid Renderer package.</li></ul><h2 id="conclusion">Conclusion</h2><p>HEcsGravitySim showcases the power of <strong>Data-Oriented Programming</strong> in Unity, enabling efficient and scalable physics simulations. With <strong>ECS, Job System, and Unity Physics</strong>, we can simulate complex gravitational interactions at real-time speeds, even with thousands of entities.</p><p>If you're interested in high-performance game development or physics simulations, exploring Unity's <strong>DOTS ecosystem</strong> is a great step forward!</p><p>Stay tuned for further improvements and optimizations! 🚀</p><h3 id="github-repository">GitHub Repository</h3><p>Check out the source code on GitHub: <a href="https://github.com/HoomanJCode/HEcsGravitySim" target="_blank" class="extlink extlink-icon-11" rel="noopener noreferrer">HEcsGravitySim</a></p><p> </p></div><footer class="content__footer"><div class="content__last-updated">This article was updated on May 2, 2025</div><div class="content__footer__col"><ul class="content__tag"><li><a href="https://hooman.jalalpoor.com/tags/art/">Art</a></li></ul><div class="content__share"></div></div><nav class="content__nav"><div class="content__nav__prev">Previous Post<h5><a href="https://hooman.jalalpoor.com/rainy-cloud-a-melancholic-yet-hopeful-puzzle-adventure/" class="invert" rel="prev">Rainy Cloud: A Melancholic Yet Hopeful Puzzle Adventure</a></h5></div><div class="content__nav__next">Next Post<h5><a href="https://hooman.jalalpoor.com/menuview-package-in-unity-simple-menu-management-tool/" class="invert" rel="next">MenuView-Package in Unity: Simple Menu Management Tool</a></h5></div></nav><div class="content__bio"><img src="https://hooman.jalalpoor.com/media/website/dfjhkk-2-2xl.png" loading="eager" height="600" width="600" alt="Hooman Jalalpoor"><div><h3><a href="https://hooman.jalalpoor.com/authors/hooman-jalalpoor/" class="invert" title="Hooman Jalalpoor">Hooman Jalalpoor</a></h3><p>Hi, I’m Hooman Jalalpoor—an Indie Game Programmer, Software Engineer, and Generative Artist. With a deep passion for creating immersive and artistic games, I specialize in game development using Unity and C#, as well as crafting unique generative art and NFTs.<br><br>My journey in game development has been driven by a love for storytelling, creativity, and innovation. I’ve participated in numerous game jams, where my team and I created award-winning games like Impasse, Balls of Chaos, and Shattered. These experiences have honed my skills in game design, team collaboration, and rapid prototyping.<br><br>Beyond games, I’ve explored the intersection of art and technology by producing generative artworks and NFTs, leveraging tools like JavaScript and p5.js. My work in this space has not only allowed me to express my creativity but also to understand the dynamics of the digital art market.<br><br>I hold a Master’s degree in Computer Software Engineering, where I focused on neural networks and blockchain technology for cryptocurrency price prediction. This academic background has equipped me with a strong foundation in machine learning, optimization, and research, which I often integrate into my projects.<br><br>Currently, I serve as the Manager of the Academy of Technical Experiences, where I oversee program development and foster a learning environment for aspiring technical professionals. This role has allowed me to grow as a leader while sharing my knowledge with others.<br><br>I’m also passionate about education and have created game-making tutorials in Persian to help aspiring developers in my community. Although this venture was cut short, I hope to continue creating educational content in the future.<br><br>When I’m not coding or designing games, you’ll find me exploring new technologies, experimenting with procedural art, or brainstorming ideas for my next project. My ultimate goal is to create games and experiences that resonate with players on an emotional and artistic level.<br><br>Let’s connect and create something amazing together!</p></div></div><div class="content__related"><h3 class="u-h5">Related posts</h3><div class="content__related__wrap"><figure><figcaption><h4><a href="https://hooman.jalalpoor.com/boost-your-unity-development-with-concurrenttools-package/" class="invert">Boost Your Unity Development with ConcurrentTools-Package</a></h4><time datetime="2025-05-02T21:50">May 2, 2025</time></figcaption></figure><figure><figcaption><h4><a href="https://hooman.jalalpoor.com/menuview-package-in-unity-simple-menu-management-tool/" class="invert">MenuView-Package in Unity: Simple Menu Management Tool</a></h4><time datetime="2025-05-02T21:41">May 2, 2025</time></figcaption></figure></div></div></footer></article></main><footer class="footer"><div class="footer__copyright">@HoomanJalalpoor</div></footer></div><script defer="defer" src="https://hooman.jalalpoor.com/assets/js/scripts.min.js?v=4268bfae06e330d473c424d50f09abda"></script><script>window.publiiThemeMenuConfig={mobileMenuMode:'sidebar',animationSpeed:300,submenuWidth: 'auto',doubleClickTime:500,mobileMenuExpandableSubmenus:true,relatedContainerForOverlayMenuSelector:'.navbar'};</script><script>/*<![CDATA[*/var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};/*]]>*/</script><div class="pcb" data-behaviour="badge" data-behaviour-link="#cookie-settings" data-revision="1" data-config-ttl="90" data-debug-mode="false"><div role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-title" aria-describedby="pcb-txt" class="pcb__banner"><div class="pcb__inner"><div id="pcb-title" role="heading" aria-level="2" class="pcb__title">This website uses cookies</div><div id="pcb-txt" class="pcb__txt">Select which cookies to opt-in to via the checkboxes below; our website uses cookies to examine site traffic and user activity while on our site, for marketing, and to provide social media functionality. <a href="#not-specified">More details...</a></div><div class="pcb__buttons"><button type="button" class="pcb__btn pcb__btn--link pcb__btn--configure" aria-haspopup="dialog">Manage preferences</button> <button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button></div></div></div><div class="pcb__popup" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="pcb-popup-title"><div class="pcb__popup__wrapper"><div class="pcb__inner pcb__popup__inner"><div class="pcb__popup__heading"><div id="pcb-popup-title" role="heading" aria-level="2" class="pcb__title">Cookie settings</div><button class="pcb__popup__close" aria-label="Close"></button></div><div class="pcb__popup__content"><div class="pcb__txt pcb__popup__txt">We use cookies to enhance your browsing experience, serve personalized ads or content, and analyze our traffic. By clicking "Accept All", you consent to our use of cookies. <a href="#not-specified">More details...</a></div><ul class="pcb__groups"><li class="pcb__group"><details><summary class="pcb__group__title no-desc">Required</summary></details><div class="pcb__popup__switch is-checked"><input type="checkbox" data-group-name="" id="pcb-group-0" checked="checked"> <label for="pcb-group-0">Required</label></div></li></ul></div><div class="pcb__buttons pcb__popup__buttons"><button type="button" class="pcb__btn pcb__btn--solid pcb__btn--accept">Accept all</button> <button type="button" class="pcb__btn pcb__btn--reject">Reject all</button> <button type="button" class="pcb__btn pcb__btn--save">Save settings</button></div></div></div></div><div class="pcb__overlay" aria-hidden="true"></div><button class="pcb__badge" aria-label="Cookie Policy" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" width="40" height="40" viewBox="0 0 23 23" fill="currentColor"><path d="M21.41 12.71c-.08-.01-.15 0-.22 0h-.03c-.03 0-.05 0-.08.01-.07 0-.13.01-.19.04-.52.21-1.44.19-2.02-.22-.44-.31-.65-.83-.62-1.53a.758.758 0 0 0-.27-.61.73.73 0 0 0-.65-.14c-1.98.51-3.49.23-4.26-.78-.82-1.08-.73-2.89.24-4.49.14-.23.14-.52 0-.75a.756.756 0 0 0-.67-.36c-.64.03-1.11-.1-1.31-.35-.19-.26-.13-.71-.01-1.29.04-.18.06-.38.03-.59-.05-.4-.4-.7-.81-.66C5.1 1.54 1 6.04 1 11.48 1 17.28 5.75 22 11.6 22c5.02 0 9.39-3.54 10.39-8.42.08-.4-.18-.78-.58-.87Zm-9.81 7.82c-5.03 0-9.12-4.06-9.12-9.06 0-4.34 3.05-8 7.25-8.86-.08.7.05 1.33.42 1.81.24.32.66.67 1.38.84-.76 1.86-.65 3.78.36 5.11.61.81 2.03 2 4.95 1.51.18.96.71 1.54 1.18 1.87.62.43 1.38.62 2.1.62.05 0 .09 0 .13-.01-1.23 3.64-4.7 6.18-8.64 6.18ZM13 17c0 .55-.45 1-1 1s-1-.45-1-1 .45-1 1-1 1 .45 1 1Zm5.29-12.3a.99.99 0 0 1-.29-.71c0-.55.45-.99 1-.99a1 1 0 0 1 .71.3c.19.19.29.44.29.71 0 .55-.45.99-1 .99a1 1 0 0 1-.71-.3ZM9 13.5c0 .83-.67 1.5-1.5 1.5S6 14.33 6 13.5 6.67 12 7.5 12s1.5.67 1.5 1.5Zm3.25.81a.744.744 0 0 1-.06-1.05c.28-.32.75-.34 1.05-.06.31.28.33.75.05 1.06-.15.16-.35.25-.56.25-.18 0-.36-.06-.5-.19ZM8.68 7.26c.41.37.44 1 .07 1.41-.2.22-.47.33-.75.33a.96.96 0 0 1-.67-.26c-.41-.37-.44-1-.07-1.41.37-.42 1-.45 1.41-.08Zm11.48 1.88c.18-.19.52-.19.7 0 .05.04.09.1.11.16.03.06.04.12.04.19 0 .13-.05.26-.15.35-.09.1-.22.15-.35.15s-.26-.05-.35-.15a.355.355 0 0 1-.11-.16.433.433 0 0 1-.04-.19c0-.13.05-.26.15-.35Zm-4.93-1.86a.75.75 0 1 1 1.059-1.06.75.75 0 0 1-1.059 1.06Z"/></svg></button></div><script>(function(win) {
    if (!document.querySelector('.pcb')) {
        return;
    }

    var cbConfig = {
        behaviour: document.querySelector('.pcb').getAttribute('data-behaviour'),
        behaviourLink: document.querySelector('.pcb').getAttribute('data-behaviour-link'),
        revision: document.querySelector('.pcb').getAttribute('data-revision'),
        configTTL: parseInt(document.querySelector('.pcb').getAttribute('data-config-ttl'), 10),
        debugMode: document.querySelector('.pcb').getAttribute('data-debug-mode') === 'true',
        initialState: null,
        initialLsState: null,
        previouslyAccepted: []
    };

    var cbUI = {
        wrapper: document.querySelector('.pcb'),
        banner: {
            element: null,
            btnAccept: null,
            btnReject: null,
            btnConfigure: null
        },
        popup: {
            element: null,
            btnClose: null,
            btnSave: null,
            btnAccept: null,
            btnReject: null,
            checkboxes: null,
        },
        overlay: null,
        badge: null,
        blockedScripts: document.querySelectorAll('script[type^="gdpr-blocker/"]'),
        triggerLinks: cbConfig.behaviourLink ? document.querySelectorAll('a[href*="' + cbConfig.behaviourLink + '"]') : null
    };

    function initUI () {
        // setup banner elements
        cbUI.banner.element = cbUI.wrapper.querySelector('.pcb__banner');
        cbUI.banner.btnAccept = cbUI.banner.element.querySelector('.pcb__btn--accept');
        cbUI.banner.btnReject = cbUI.banner.element.querySelector('.pcb__btn--reject');
        cbUI.banner.btnConfigure = cbUI.banner.element.querySelector('.pcb__btn--configure');

        // setup popup elements
        if (cbUI.wrapper.querySelector('.pcb__popup')) {
            cbUI.popup.element = cbUI.wrapper.querySelector('.pcb__popup');
            cbUI.popup.btnClose = cbUI.wrapper.querySelector('.pcb__popup__close');
            cbUI.popup.btnSave = cbUI.popup.element.querySelector('.pcb__btn--save');
            cbUI.popup.btnAccept = cbUI.popup.element.querySelector('.pcb__btn--accept');
            cbUI.popup.btnReject = cbUI.popup.element.querySelector('.pcb__btn--reject');
            cbUI.popup.checkboxes = cbUI.popup.element.querySelector('input[type="checkbox"]');
            // setup overlay
            cbUI.overlay = cbUI.wrapper.querySelector('.pcb__overlay');
        }

        cbUI.badge = cbUI.wrapper.querySelector('.pcb__badge');

        if (cbConfig.behaviour.indexOf('link') > -1) {
            for (var i = 0; i < cbUI.triggerLinks.length; i++) {
                cbUI.triggerLinks[i].addEventListener('click', function(e) {
                    e.preventDefault();
                    showBannerOrPopup();
                });
            }
        }
    }

    function initState () {
        var lsKeyName = getConfigName();
        var currentConfig = localStorage.getItem(lsKeyName);
        var configIsFresh = checkIfConfigIsFresh();

        if (!configIsFresh || currentConfig === null) {
            if (cbConfig.debugMode) {
                console.log('🍪 Config not found, or configuration expired');
            }

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                    'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                    'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                    'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                    'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                    'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                    'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                });  
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': window.publiiCBGCM.defaultState.ad_storage ? 'granted' : 'denied',
                        'ad_personalization': window.publiiCBGCM.defaultState.ad_personalization ? 'granted' : 'denied',
                        'ad_user_data': window.publiiCBGCM.defaultState.ad_user_data ? 'granted' : 'denied',
                        'analytics_storage': window.publiiCBGCM.defaultState.analytics_storage ? 'granted' : 'denied',
                        'personalization_storage': window.publiiCBGCM.defaultState.personalization_storage ? 'granted' : 'denied',
                        'functionality_storage': window.publiiCBGCM.defaultState.functionality_storage ? 'granted' : 'denied',
                        'security_storage': window.publiiCBGCM.defaultState.security_storage ? 'granted' : 'denied'
                    }));
                }
            }

            showBanner();
        } else if (typeof currentConfig === 'string') {
            if (cbConfig.debugMode) {
                console.log('🍪 Config founded');
            }

            cbConfig.initialLsState = currentConfig.split(',');

            if (window.publiiCBGCM) {
                gtag('consent', 'default', {
                    'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                    'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                    'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                    'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                    'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                    'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                    'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                });
                
                if (cbConfig.debugMode) {
                    console.log('🍪 GCMv2 DEFAULT STATE: ' + JSON.stringify({
                        'ad_storage': getDefaultConsentState(currentConfig, 'ad_storage'),
                        'ad_personalization': getDefaultConsentState(currentConfig, 'ad_personalization'),
                        'ad_user_data': getDefaultConsentState(currentConfig, 'ad_user_data'),
                        'analytics_storage': getDefaultConsentState(currentConfig, 'analytics_storage'),
                        'personalization_storage': getDefaultConsentState(currentConfig, 'personalization_storage'),
                        'functionality_storage': getDefaultConsentState(currentConfig, 'functionality_storage'),
                        'security_storage': getDefaultConsentState(currentConfig, 'security_storage')
                    }));
                }
            }

            showBadge();

            if (cbUI.popup.element) {
                var allowedGroups = currentConfig.split(',');
                var checkedCheckboxes = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');

                for (var j = 0; j < checkedCheckboxes.length; j++) {
                    var name = checkedCheckboxes[j].getAttribute('data-group-name');

                    if (name && name !== '-' && allowedGroups.indexOf(name) === -1) {
                        checkedCheckboxes[j].checked = false;
                    }
                }

                for (var i = 0; i < allowedGroups.length; i++) {
                    var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + allowedGroups[i] + '"]');

                    if (checkbox) {
                        checkbox.checked = true;
                    }

                    allowCookieGroup(allowedGroups[i]);
                }
            }
        }

        setTimeout(function () {
            cbConfig.initialState = getInitialStateOfConsents();
        }, 0);
    }

    function checkIfConfigIsFresh () {
        var lastConfigSave = localStorage.getItem('publii-gdpr-cookies-config-save-date');

        if (lastConfigSave === null) {
            return false;
        }

        lastConfigSave = parseInt(lastConfigSave, 10);

        if (lastConfigSave === 0) {
            return true;
        }

        if (+new Date() - lastConfigSave < cbConfig.configTTL * 24 * 60 * 60 * 1000) {
            return true;
        }

        return false;
    }

    function getDefaultConsentState (currentConfig, consentGroup) {
        let configGroups = currentConfig.split(',');

        for (let i = 0; i < configGroups.length; i++) {
            let groupName = configGroups[i];
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === groupName);

            if (group && group[consentGroup]) {
                return 'granted';
            }
        }  
        
        if (window.publiiCBGCM.defaultState[consentGroup]) {
            return 'granted'; 
        }
        
        return 'denied';
    }

    function initBannerEvents () {
        cbUI.banner.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('banner');
            showBadge();
        }, false);

        if (cbUI.banner.btnReject) {
            cbUI.banner.btnReject.addEventListener('click', function (e) {
                e.preventDefault();
                rejectAllCookies();
                showBadge();
            }, false);
        }

        if (cbUI.banner.btnConfigure) {
            cbUI.banner.btnConfigure.addEventListener('click', function (e) {
                e.preventDefault();
                hideBanner();
                showAdvancedPopup();
                showBadge();
            }, false);
        }
    }

    function initPopupEvents () {
        if (!cbUI.popup.element) {
            return;
        }

        cbUI.overlay.addEventListener('click', function (e) {
            hideAdvancedPopup();
        }, false);

        cbUI.popup.element.addEventListener('click', function (e) {
            e.stopPropagation();
        }, false);

        cbUI.popup.btnAccept.addEventListener('click', function (e) {
            e.preventDefault();
            acceptAllCookies('popup');
        }, false);

        cbUI.popup.btnReject.addEventListener('click', function (e) {
            e.preventDefault();
            rejectAllCookies();
        }, false);

        cbUI.popup.btnSave.addEventListener('click', function (e) {
            e.preventDefault();
            saveConfiguration();
        }, false);

        cbUI.popup.btnClose.addEventListener('click', function (e) {
            e.preventDefault();
            hideAdvancedPopup();
        }, false);
    }

    function initBadgeEvents () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.addEventListener('click', function (e) {
            showBannerOrPopup();
        }, false);
    }

    initUI();
    initState();
    initBannerEvents();
    initPopupEvents();
    initBadgeEvents();

    /**
     * API
     */
    function addScript (src, inline) {
        var newScript = document.createElement('script');

        if (src) {
            newScript.setAttribute('src', src);
        }

        if (inline) {
            newScript.text = inline;
        }

        document.body.appendChild(newScript);
    }

    function allowCookieGroup (allowedGroup) {
        var scripts = document.querySelectorAll('script[type="gdpr-blocker/' + allowedGroup + '"]');
        cbConfig.previouslyAccepted.push(allowedGroup);
    
        for (var j = 0; j < scripts.length; j++) {
            addScript(scripts[j].src, scripts[j].text);
        }

        var groupEvent = new Event('publii-cookie-banner-unblock-' + allowedGroup);
        document.body.dispatchEvent(groupEvent);
        unlockEmbeds(allowedGroup);

        if (cbConfig.debugMode) {
            console.log('🍪 Allowed group: ' + allowedGroup);
        }

        if (window.publiiCBGCM && (!cbConfig.initialLsState || cbConfig.initialLsState.indexOf(allowedGroup) === -1)) {
            let consentResult = {};
            let group = window.publiiCBGCM.groups.find(group => group.cookieGroup === allowedGroup);

            if (group) {
                let foundSomeConsents = false;

                Object.keys(group).forEach(key => {
                    if (key !== 'cookieGroup' && group[key] === true) {
                        consentResult[key] = 'granted';
                        foundSomeConsents = true;
                    }
                });

                if (foundSomeConsents) {
                    gtag('consent', 'update', consentResult);   

                    if (cbConfig.debugMode) {
                        console.log('🍪 GCMv2 UPDATE: ' + JSON.stringify(consentResult));
                    }
                }
            }
        }
    }

    function showBannerOrPopup () {
        if (cbUI.popup.element) {
            showAdvancedPopup();
        } else {
            showBanner();
        }
    }

    function showAdvancedPopup () {
        cbUI.popup.element.classList.add('is-visible');
        cbUI.overlay.classList.add('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'false');
        cbUI.overlay.setAttribute('aria-hidden', 'false');
    }

    function hideAdvancedPopup () {
        cbUI.popup.element.classList.remove('is-visible');
        cbUI.overlay.classList.remove('is-visible');
        cbUI.popup.element.setAttribute('aria-hidden', 'true');
        cbUI.overlay.setAttribute('aria-hidden', 'true');
    }

    function showBanner () {
        cbUI.banner.element.classList.add('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'false');
    }

    function hideBanner () {
        cbUI.banner.element.classList.remove('is-visible');
        cbUI.banner.element.setAttribute('aria-hidden', 'true');
    }

    function showBadge () {
        if (!cbUI.badge) {
            return;
        }

        cbUI.badge.classList.add('is-visible');
        cbUI.badge.setAttribute('aria-hidden', 'false');
    }

    function getConfigName () {
        var lsKeyName = 'publii-gdpr-allowed-cookies';

        if (cbConfig.revision) {
            lsKeyName = lsKeyName + '-v' + parseInt(cbConfig.revision, 10);
        }

        return lsKeyName;
    }

    function storeConfiguration (allowedGroups) {
        var lsKeyName = getConfigName();
        var dataToStore = allowedGroups.join(',');
        localStorage.setItem(lsKeyName, dataToStore);

        if (cbConfig.configTTL === 0) {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', 0);

            if (cbConfig.debugMode) {
                console.log('🍪 Store never expiring configuration');
            }
        } else {
            localStorage.setItem('publii-gdpr-cookies-config-save-date', +new Date());
        }
    }

    function getInitialStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Initial state: ' + groups.join(', '));
        }

        return groups;
    }

    function getCurrentStateOfConsents () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]:checked');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 State to save: ' + groups.join(', '));
        }

        return groups;
    }

    function getAllGroups () {
        if (!cbUI.popup.element) {
            return [];
        }

        var checkedGroups = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');
        var groups = [];

        for (var i = 0; i < checkedGroups.length; i++) {
            var allowedGroup = checkedGroups[i].getAttribute('data-group-name');

            if (allowedGroup !== '') {
                groups.push(allowedGroup);
            }
        }

        return groups;
    }

    function acceptAllCookies (source) {
        var groupsToAccept = getAllGroups();
        storeConfiguration(groupsToAccept);

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        if (cbUI.popup.element) {
            var checkboxesToCheck = cbUI.popup.element.querySelectorAll('input[type="checkbox"]');

            for (var j = 0; j < checkboxesToCheck.length; j++) {
                checkboxesToCheck[j].checked = true;
            }
        }

        if (cbConfig.debugMode) {
            console.log('🍪 Accept all cookies: ', groupsToAccept.join(', '));
        }

        if (source === 'popup') {
            hideAdvancedPopup();
        } else if (source === 'banner') {
            hideBanner();
        }
    }

    function rejectAllCookies () {
        if (cbConfig.debugMode) {
            console.log('🍪 Reject all cookies');
        }

        storeConfiguration([]);
        setTimeout(function () {
            window.location.reload();
        }, 100);
    }

    function saveConfiguration () {
        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }

        if (reloadIsNeeded(groupsToAccept)) {
            setTimeout(function () {
                window.location.reload();
            }, 100);
            return;
        }

        for (var i = 0; i < groupsToAccept.length; i++) {
            var group = groupsToAccept[i];

            if (cbConfig.initialState.indexOf(group) > -1 || cbConfig.previouslyAccepted.indexOf(group) > -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Skip previously activated group: ' + group);
                }

                continue;
            }

            allowCookieGroup(group);
        }

        hideAdvancedPopup();
    }

    function reloadIsNeeded (groupsToAccept) {
        // check if user rejected consent for initial groups
        var initialGroups = cbConfig.initialState;
        var previouslyAcceptedGroups = cbConfig.previouslyAccepted;
        var groupsToCheck = initialGroups.concat(previouslyAcceptedGroups);

        for (var i = 0; i < groupsToCheck.length; i++) {
            var groupToCheck = groupsToCheck[i];

            if (groupToCheck !== '' && groupsToAccept.indexOf(groupToCheck) === -1) {
                if (cbConfig.debugMode) {
                    console.log('🍪 Reload is needed due lack of: ', groupToCheck);
                }

                return true;
            }
        }

        return false;
    }

    function unlockEmbeds (cookieGroup) {
        var iframesToUnlock = document.querySelectorAll('.pec-wrapper[data-consent-group-id="' + cookieGroup + '"]');

        for (var i = 0; i < iframesToUnlock.length; i++) {
            var iframeWrapper = iframesToUnlock[i];
            iframeWrapper.querySelector('.pec-overlay').classList.remove('is-active');
            iframeWrapper.querySelector('.pec-overlay').setAttribute('aria-hidden', 'true');
            var iframe = iframeWrapper.querySelector('iframe');
            iframe.setAttribute('src', iframe.getAttribute('data-consent-src'));
        }
    }

    win.publiiEmbedConsentGiven = function (cookieGroup) {
        // it will unlock embeds
        allowCookieGroup(cookieGroup);

        var checkbox = cbUI.popup.element.querySelector('input[type="checkbox"][data-group-name="' + cookieGroup + '"]');

        if (checkbox) {
            checkbox.checked = true;
        }

        var groupsToAccept = getCurrentStateOfConsents();
        storeConfiguration(groupsToAccept);

        if (cbConfig.debugMode) {
            console.log('🍪 Save new config: ', groupsToAccept.join(', '));
        }
    }
})(window);</script></body></html>